#!/usr/bin/env php
<?php

$DVC_VERSION = '1.0.6';

// Optional ASCII splash
echo <<<ASCII
  _____    ___    ___  ______
 |   _  \  \  \  /  / |   ___\
 |  | |  |  \  \/  /  |  |
 |  |_|  |   \    /   |  |___
 |______/     \__/    |______/
  ____  _   _ ____      _____                                          _
 |  _ \| | | |  _ \    |  _ _|_  __ _ _ __ ___   ___ _     __ ___  _ _| | __
 | |_) | |_| | |_) |   | |_| '_`/ _` | '_ ` _ \ / _ \ \   / // _ \| '_` |/ /
 |  __/|  _  |  __/    |  _| | | (_| | | | | | |  __|\ `^' /| (_) | | |  <
 |_|   |_| |_|_|       |_| |_|  \__,_|_| |_| |_|\___| \_^_/  \___/|_| |_|\_\ ...

DVC CLI â€” v $DVC_VERSION

ASCII;


/**
 * https://www.php.net/manual/en/reserved.variables.argv.php
 *
 * $argv is a php predefined variable
 * Contains an array of all the arguments passed to the script
 * when running from the command line.
 */
// Parse arguments
$args = $argv;
array_shift($args); // remove script name

$command = $args[0] ?? null;
$port = 1265; // default port

// Parse additional arguments
foreach ($args as $arg) {
  if (preg_match('/--port=(\d+)/', $arg, $matches)) {
    $port = (int)$matches[1];
  }
}

final class utility {

  public static $port = 1265;

  protected static function checkVSCodeSettings(): void {
    $settingsFile = '.vscode/settings.json';
    $required = [
      "sqltools.connections" => [
        [
          "previewLimit" => 50,
          "driver" => "SQLite",
          "name" => "db",
          "database" => "src/data/db.sqlite"
        ]
      ],
      "sqltools.useNodeRuntime" => true,
      "sqltools.autoOpenSessionFiles" => false
    ];

    $changed = false;
    $settings = [];

    if (file_exists($settingsFile)) {
      $settings = json_decode(file_get_contents($settingsFile), true) ?? [];
    }

    foreach ($required as $key => $value) {

      if (!array_key_exists($key, $settings)) {
        $settings[$key] = $value;
        $changed = true;
      }
    }

    if ($changed || !file_exists($settingsFile)) {

      if (!is_dir('.vscode')) mkdir('.vscode', 0777, true);
      file_put_contents($settingsFile, json_encode($settings, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
      echo "Updated VSCode settings: $settingsFile\n";
    } else {

      echo "VSCode settings already contain required SQLTools configuration.\n";
    }
  }

  protected static function checkVSCodeTasks(): void {

    $tasksFile = '.vscode/tasks.json';
    $required = [
      "version" => "2.0.0",
      "tasks" => [
        [
          "label" => "ðŸš€ Launch Dev Server",
          "type" => "shell",
          "command" => "vendor/bin/dvc serve --port=8010",
          "problemMatcher" => [],
          "isBackground" => true,
          "presentation" => [
            "reveal" => "always",
            "panel" => "new"
          ]
        ],
        [
          "label" => "Composer Update",
          "type" => "shell",
          "command" => "composer update",
          "problemMatcher" => [],
          "icon" => [
            "id" => "sync"
          ],
          "presentation" => [
            "reveal" => "always",
            "panel" => "new"
          ]
        ],
        [
          "label" => "Make DVC Module",
          "type" => "shell",
          "command" => "vendor/bin/dvc",
          "args" => [
            "make::crud-module",
            "--name=\${input:moduleName}",
            "--fields=\${input:fields}"
          ],
          "problemMatcher" => [],
          "icon" => [
            "id" => "tools"
          ],
          "group" => [
            "kind" => "build",
            "isDefault" => true
          ]
        ]
      ],
      "inputs" => [
        [
          "id" => "moduleName",
          "type" => "promptString",
          "description" => "Module name (e.g. ideas)"
        ],
        [
          "id" => "fields",
          "type" => "promptString",
          "description" => "Comma-separated fields (e.g. title,description)"
        ]
      ]
    ];

    $changed = false;
    $tasks = [];

    if (file_exists($tasksFile)) {
      $tasks = json_decode(file_get_contents($tasksFile), true) ?? [];
    }

    foreach ($required as $key => $value) {
      if (!array_key_exists($key, $tasks) || $tasks[$key] !== $value) {
        $tasks[$key] = $value;
        $changed = true;
      }
    }

    if ($changed || !file_exists($tasksFile)) {
      if (!is_dir('.vscode')) mkdir('.vscode', 0777, true);
      file_put_contents($tasksFile, json_encode($tasks, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
      echo "Updated VSCode tasks: $tasksFile\n";
    } else {
      echo "VSCode tasks already contain the standard dev server launch task.\n";
    }

    // check if .github/prompts folder exists and create if not
    $dir = '.github';


    // copy in .github/copilot-instructions.md
    $files = [
      $dir . '/copilot-instructions.md' => 'vendor/bravedave/dvc/.github/copilot-instructions.md',
    ];

    utility::checkDirectories([$dir]);
    utility::checkFiles($files);
  }

  protected static function makeCrudConfig(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/config.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use config as rootConfig;',
        '',
        'class config extends rootConfig {',
        '',
        sprintf('  const %s_db_version = 1;', $name),
        '',
        sprintf('  const label = \'%s\';', ucwords($name)),
        '',
        sprintf('  static function %s_checkdatabase() {', $name),
        '',
        '    $dao = new dao\dbinfo;',
        sprintf('    $dao->checkVersion(\'%s\', self::%s_db_version);', $name, $name),
        '  }',
        '}',
      ];

      file_put_contents($file, implode("\n", $content));
      echo "created config class: $file\n";
    } else {

      echo "config class already exists: $file\n";
    }
  }

  protected static function makeCrudController(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/controller.php';
    if (!file_exists($file)) {

      $content = [

        '<?php',
        '/*',
        sprintf(' * file: %s', $file),
        ' * MIT License',
        ' */',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use bravedave\dvc\{ controller as dvcController, ServerRequest};',
        '',
        'class controller extends dvcController {',
        '',
        '  protected function _index() {',
        '',
        '    $this->data = (object)[',
        '      \'title\' => $this->title = config::label,',
        '    ];',
        '',
        '    $this->renderBS5([',
        '      \'aside\' => fn() => $this->load(\'index\'),',
        '      \'main\' => fn() => $this->load(\'matrix\')',
        '    ]);',
        '  }',
        '',
        '  protected function before() {',
        '',
        sprintf('    config::%s_checkdatabase();', $name),
        '    parent::before();',
        '    $this->viewPath[] = __DIR__ . \'/views/\';',
        '  }',
        '',
        '  protected function postHandler() {',
        '',
        '    $request = new ServerRequest;',
        '    $action = $request(\'action\');',
        ''
      ];

      $content[] = '    /*';
      $content[] = sprintf('      _brayworth_.fetch.post(_brayworth_.url(\'%s\'),{', $name);
      $content[] = '        action: \'delete\',';
      $content[] = '        id : 1';
      $content[] = '      }).then(console.log);';
      $content[] = '';
      $content[] = sprintf('      _brayworth_.fetch.post(_brayworth_.url(\'%s\'),{', $name);
      $content[] = '        action: \'get-by-id\',';
      $content[] = '        id : 1';
      $content[] = '      }).then(console.log);';
      $content[] = '';
      $content[] = sprintf('      _brayworth_.fetch.post(_brayworth_.url(\'%s\'),{', $name);
      $content[] = '        action: \'get-matrix\'';
      $content[] = '      }).then(console.log);';
      $content[] = '    */';
      $content[] = '    return match ($action) {';
      $content[] = sprintf('      \'%s-delete\' => handler::%sDelete($request),', $name, $name);
      $content[] = sprintf('      \'get-by-id\' => handler::%sGetByID($request),', $name);
      $content[] = sprintf('      \'get-matrix\' => handler::%sGetMatrix($request),', $name);;
      $content[] = sprintf('      \'%s-save\' => handler::%sSave($request),', $name, $name);
      $content[] = '      default => parent::postHandler()';
      $content[] = '    };';

      $content[] = '  }';
      $content[] = '';
      $content[] = '  public function edit($id = 0) {';
      $content[] = '    // tip : the structure is available in the view at $this->data->dto';
      $content[] = '    $this->data = (object)[';
      $content[] = '      \'title\' => $this->title = config::label,';
      $content[] = sprintf('      \'dto\' => new dao\dto\%s', $name);
      $content[] = '    ];';
      $content[] = '';
      $content[] = '    if ($id = (int)$id) {';
      $content[] = sprintf('      $dao = new dao\%s;', $name);
      $content[] = '      $this->data->dto = $dao->getByID($id);';
      $content[] = '      $this->data->title .= \' edit\';';
      $content[] = '    }';
      $content[] = '';
      $content[] = '    $this->load(\'edit\');';
      $content[] = '  }';
      $content[] = '}';


      file_put_contents($file, implode("\n", $content));
      echo "Created Controller class: $file\n";
    } else {

      echo "Controller class already exists: $file\n";
    }
  }

  protected static function makeCrudDBMaintence(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/dao/db/' . $name . '.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        '/**',
        ' * note:',
        ' *  id, autoincrement primary key is added to all tables - no need to specify',
        ' *  field types are MySQL and are converted to SQLite equivalents as required',
        ' */',
        '',
        sprintf('$dbc = \sys::dbCheck(\'%s\');',  $name),
        '',
      ];

      if (!in_array('created', $fields)) {
        $content[] = '$dbc->defineField(\'created\', \'datetime\');';
      }

      if (!in_array('updated', $fields)) {
        $content[] = '$dbc->defineField(\'updated\', \'datetime\');';
      }

      $content[] = '';

      foreach ($fields as $field) {
        $content[] = sprintf('$dbc->defineField(\'%s\', \'varchar\');', $field);
      }

      $content[] = '';
      $content[] = '$dbc->check();  // actually do the work, check that table and fields exist';

      file_put_contents($file, implode("\n", $content));
      echo "Created DB maintenance class: $file\n";
    } else {

      echo "DB maintenance class already exists: $file\n";
    }
  }

  protected static function makeCrudDAO(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/dao/' . $name . '.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s\dao;', $name),
        '',
        'use bravedave\dvc\{dao, dtoSet};',
        '',
        sprintf('class %s extends dao {', $name),
        sprintf("  protected \$_db_name = '%s';", $name),
        sprintf("  protected \$template = dto\%s::class;", $name),
        '',
        '  public function getMatrix() : array {',
        '',
        sprintf('    return (new dtoSet)(\'SELECT * FROM `%s`\'); // an array of records', $name),
        '  }',
        '',
        '  public function Insert($a) {',
        '    $a[\'created\'] = $a[\'updated\'] = self::dbTimeStamp();',
        '    return parent::Insert($a);',
        '  }',
        '',
        '  public function UpdateByID($a, $id) {',
        '    $a[\'updated\'] = self::dbTimeStamp();',
        '    return parent::UpdateByID($a, $id);',
        '  }'
      ];

      $content[] = '}';

      file_put_contents($file, implode("\n", $content));
      echo "Created DB dao class: $file\n";
    } else {

      echo "DB dao class already exists: $file\n";
    }
  }

  protected static function makeCrudDBInfo(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/dao/dbinfo.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s\dao;', $name),
        '',
        'use bravedave\dvc\dbinfo as dvcDbInfo;',
        '',
        'class dbinfo extends dvcDbInfo {',
        '  protected function check() {',
        '    parent::check();',
        '    parent::checkDIR(__DIR__);',
        '  }',
        '}',
      ];

      file_put_contents($file, implode("\n", $content));
      echo "Created DBinfo class: $file\n";
    } else {

      echo "DBinfo class already exists: $file\n";
    }
  }

  protected static function makeCrudDTO(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/dao/dto/' . $name . '.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s\dao\dto;', $name),
        '',
        'use bravedave\dvc\dto;',
        '',
        sprintf('class %s extends dto {', $name),
        '  public $id = 0;',
      ];

      if (!in_array('created', $fields)) {
        $content[] = "  public \$created = '';";
      }

      if (!in_array('updated', $fields)) {
        $content[] = "  public \$updated = '';";
      }

      foreach ($fields as $field) {
        $content[] = sprintf('  public $%s = \'\';', $field);
      }

      $content[] = '}';


      file_put_contents($file, implode("\n", $content));
      echo "Created DB dto class: $file\n";
    } else {

      echo "DB dto class already exists: $file\n";
    }
  }

  protected static function makeCrudHandler(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/handler.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use bravedave\dvc\{ServerRequest, json};',
        '',
        'final class handler {',
        '',
        sprintf('  public static function %sDelete(ServerRequest $request): json {', $name),
        '',
        '    $action = $request(\'action\');',
        '    if ($id = (int)$request(\'id\')) {',
        '',
        sprintf('      (new dao\%s)->delete($id);', $name),
        '      return json::ack($action);',
        '    }',
        '',
        '    return json::ack($action);',
        '  }',
        '',
        sprintf('  public static function %sGetByID(ServerRequest $request): json {', $name),
        '',
        '    $action = $request(\'action\');',
        '    if ($id = (int)$request(\'id\')) {',
        '',
        sprintf('      if ($dto = (new dao\%s)->getByID($id)) {', $name),
        '',
        '        return json::ack($action, $dto);',
        '      }',
        '    }',
        '    return json::nak($action);',
        '  }',
        '',
        sprintf('  public static function %sGetMatrix(ServerRequest $request): json {', $name),
        '',
        '    $action = $request(\'action\');',
        sprintf('    return json::ack($action, (new dao\%s)->getMatrix());', $name),
        '  }',
        '',
        sprintf('  public static function %sSave(ServerRequest $request): json {', $name),
        '',
        '    $action = $request(\'action\');',
        '    $a = [',
      ];
      foreach ($fields as $field) {
        $content[] = sprintf('      \'%s\' => $request(\'%s\'),', $field, $field);
      }

      $content[] = '    ];';
      $content[] = '';
      $content[] = sprintf('    $dao = new dao\%s;', $name);
      $content[] = '    if ($id = (int)$request(\'id\')) {';
      $content[] = '';
      $content[] = '      $dao->UpdateByID($a, $id);';
      $content[] = '    } else {';
      $content[] = '      $dao->Insert($a);';
      $content[] = '    }';
      $content[] = '';
      $content[] = '    return json::ack($action);';
      $content[] = '';
      $content[] = '  }';
      $content[] = '}';

      file_put_contents($file, implode("\n", $content));
      echo "Created handler class: $file\n";
    } else {

      echo "handler class already exists: $file\n";
    }
  }

  protected static function makeCrudViewEdit(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/views/edit.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use bravedave\dvc\{strings, theme};',
        '',
        '// note: $dto and $title into the environment ?>',
        '<form id="<?= $_form = strings::rand() ?>" autocomplete="off">',
        '',
        sprintf('  <input type="hidden" name="action" value="%s-save">', $name),
        '  <input type="hidden" name="id" value="<?= $dto->id ?>">',
        '',
        '  <div class="modal fade" tabindex="-1" role="dialog" id="<?= $_modal = strings::rand() ?>" aria-labelledby="<?= $_modal ?>Label" aria-modal="true" aria-hidden="true">',
        '    <div class="modal-dialog modal-lg modal-fullscreen-lg-down modal-dialog-centered" role="document">',
        '      <div class="modal-content">',
        '',
        '        <div class="modal-header <?= theme::modalHeader() ?>">',
        '          <h5 class="modal-title" id="<?= $_modal ?>Label"><?= $this->title ?></h5>',
        '          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>',
        '        </div>',
        '',
        '        <div class="modal-body">',
        '',
      ];

      foreach ($fields as $field) {
        $content[] = sprintf('          <!-- --[%s]-- -->', $field);
        $content[] = '          <div class="row g-2">';
        $content[] = '';
        $content[] = sprintf('            <div class="col-md-3 col-form-label text-truncate">%s</div>', $field);
        $content[] = '            <div class="col mb-2">';
        $content[] = '';
        $content[] = sprintf('              <input type="text" class="form-control" name="%s" value="<?= $dto->%s ?>">', $field, $field);
        $content[] = '            </div>';
        $content[] = '          </div>';
      }
      $content[] = '';
      $content[] = '        </div>';
      $content[] = '';
      $content[] = '        <div class="modal-footer">';
      $content[] = '';
      $content[] = '          <button type="submit" class="btn btn-primary">Save</button>';
      $content[] = '        </div>';
      $content[] = '      </div>';
      $content[] = '    </div>';
      $content[] = '  </div>';
      $content[] = '  <script>';
      $content[] = '    (_ => {';
      $content[] = '      const form = $(\'#<?= $_form ?>\');';
      $content[] = '      const modal = $(\'#<?= $_modal ?>\');';
      $content[] = '';
      $content[] = '      modal.on(\'shown.bs.modal\', () => {';
      $content[] = '';
      $content[] = '        form.on(\'submit\', function(e) {';
      $content[] = '';
      $content[] = '          _.fetch.post.form(_.url(\'<?= $this->route ?>\'),this).then(d => {';
      $content[] = '';
      $content[] = '            if (\'ack\' == d.response) {';
      $content[] = '';
      $content[] = '              modal.trigger(\'success\');';
      $content[] = '              modal.modal(\'hide\');';
      $content[] = '            } else {';
      $content[] = '';
      $content[] = '              _.growl(d);';
      $content[] = '            }';
      $content[] = '          });';
      $content[] = '';
      $content[] = '          // console.table( _data);';
      $content[] = '';
      $content[] = '          return false;';
      $content[] = '        });';
      $content[] = '';
      $content[] = '        form.find(\'input:not([type="hidden"]), select, textarea\').first().focus();';
      $content[] = '      });';
      $content[] = '    })(_brayworth_);';
      $content[] = '  </script>';
      $content[] = '</form>';

      file_put_contents($file, implode("\n", $content));
      echo "Created views/edit class: $file\n";
    } else {

      echo "views/edit class already exists: $file\n";
    }
  }

  protected static function makeCrudViewIndex(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/views/index.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s; ?>', $name),
        '',
        '<h1><?= config::label ?></h1>',
        ''
      ];

      file_put_contents($file, implode("\n", $content));
      echo "Created views/index class: $file\n";

      $menu = [];
      $menuJson = 'src/menu.json';
      // logger::info( sprintf('<menuJson : %s> %s', $menuJson, logger::caller()));

      if (file_exists($menuJson)) {

        $menu = (array)json_decode(file_get_contents($menuJson), true);
      }

      $menu[] = [
        'title' => ucwords($name),
        'url' => $name,
        'icon' => 'bi bi-dot'
      ];

      if (file_exists($menuJson)) unlink($menuJson);
      file_put_contents($menuJson, json_encode($menu, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES));
      echo "Created/Updated menu.json: $menuJson\n";
    } else {

      echo "views/index class already exists: $file\n";
    }
  }

  protected static function makeCrudViewMatrix(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/views/matrix.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use bravedave\dvc\strings; ?>',
        '',
        '<div class="row gx-2 mb-2 d-print-none">',
        '  <div class="col">',
        '    <div class="input-group">',
        '      <input type="search" accesskey="/" class="form-control" id="<?= $_search = strings::rand() ?>" autofocus>',
        '    </div>',
        '  </div>',
        '',
        '  <div class="col-auto">',
        '    <button class="btn btn-outline-primary" id="<?= $_uidAdd = strings::rand() ?>">',
        '      <i class="bi bi-plus-circle"></i> new',
        '    </button>',
        '  </div>',
        '</div>',
        '',
        '<div class="table-responsive">',
        '  <table class="table table-sm" id="<?= $_table = strings::rand() ?>">',
        '    <thead class="small">',
        '      <tr>',
      ];

      foreach ($fields as $field) {
        $content[] = sprintf('        <td>%s</td>', $field);
      }
      $content[] = '      </tr>';
      $content[] = '    </thead>';
      $content[] = '';
      $content[] = '    <tbody></tbody>';
      $content[] = '  </table>';
      $content[] = '</div>';
      $content[] = '<script>';
      $content[] = '  (_ => {';
      $content[] = '    const table = $(\'#<?= $_table ?>\');';
      $content[] = '    const search = $(\'#<?= $_search ?>\');';
      $content[] = '';
      $content[] = '    const contextmenu = function(e) {';
      $content[] = '';
      $content[] = '      if (e.shiftKey) return;';
      $content[] = '      const _ctx = _.context(e); // hides any open contexts and stops bubbling';
      $content[] = '';
      $content[] = '      _ctx.append.a({';
      $content[] = '        html: \'<i class="bi bi-pencil"></i>edit\',';
      $content[] = '        click: e => $(this).trigger(\'edit\')';
      $content[] = '      });';
      $content[] = '';
      $content[] = '      _ctx.append.a({';
      $content[] = '        html: \'<i class="bi bi-trash"></i>delete\',';
      $content[] = '        click: e => $(this).trigger(\'delete\')';
      $content[] = '      });';
      $content[] = '';
      $content[] = '      _ctx.open(e);';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    const edit = function() {';
      $content[] = '';
      $content[] = '      _.get.modal(_.url(`<?= $this->route ?>/edit/${this.dataset.id}`))';
      $content[] = '        .then(m => m.on(\'success\', e => $(this).trigger(\'refresh\')));';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    const getMatrix = () => new Promise((resolve, reject) => {';
      $content[] = '';
      $content[] = '      _.fetch.post(_.url(\'<?= $this->route ?>\'), {';
      $content[] = '        action: \'get-matrix\'';
      $content[] = '      }).then(d => \'ack\' == d.response ? resolve(d.data) : _.growl(d));';
      $content[] = '    });';
      $content[] = '';
      $content[] = '    const matrix = data => {';
      $content[] = '';
      $content[] = '      const tbody = table.find(\'> tbody\').empty();';
      $content[] = '      $.each(data, (i, dto) => {';
      $content[] = '        $(`<tr class="pointer" data-id="${dto.id}">';
      foreach ($fields as $field) {
        $content[] = sprintf('            <td class="js-%s">${dto.%s}</td>', $field, $field);
      }
      $content[] = '          </tr>`)';
      $content[] = '          .on(\'click\', function(e) {';
      $content[] = '';
      $content[] = '            e.stopPropagation();';
      $content[] = '            $(this).trigger(\'edit\');';
      $content[] = '          })';
      $content[] = '          .on(\'contextmenu\', contextmenu)';
      $content[] = '          .on(\'delete\', rowDelete)';
      $content[] = '          .on(\'edit\', edit)';
      $content[] = '          .on(\'refresh\', rowRefresh)';
      $content[] = '          .appendTo(tbody);';
      $content[] = '      });';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    const refresh = () => getMatrix().then(matrix).catch(_.growl);';
      $content[] = '';
      $content[] = '    const rowDelete = function(e) {';
      $content[] = '';
      $content[] = '      e.stopPropagation();';
      $content[] = '';
      $content[] = '      _.fetch';
      $content[] = '        .post(_.url(\'<?= $this->route ?>\'), {';
      $content[] = sprintf('          action: \'%s-delete\',', $name);
      $content[] = '          id: this.dataset.id';
      $content[] = '        })';
      $content[] = '        .then(d => {';
      $content[] = '          if (\'ack\' == d.response) {';
      $content[] = '            this.remove();';
      $content[] = '          } else {';
      $content[] = '            _.growl(d);';
      $content[] = '          }';
      $content[] = '        });';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    const rowRefresh = function(e) {';
      $content[] = '      e.stopPropagation();';
      $content[] = '';
      $content[] = '      const row = $(this);';
      $content[] = '';
      $content[] = '      _.fetch.post(_.url(\'<?= $this->route ?>\'), {';
      $content[] = '        action: \'get-by-id\',';
      $content[] = '        id: this.dataset.id';
      $content[] = '      }).then(d => {';
      $content[] = '';
      $content[] = '        if (\'ack\' == d.response) {';
      $content[] = '';
      foreach ($fields as $field) {
        $content[] = sprintf('          row.find(\'.js-%s\').html(d.data.%s);', $field, $field);
      }
      $content[] = '        } else {';
      $content[] = '';
      $content[] = '          _.growl(d);';
      $content[] = '        }';
      $content[] = '      });';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    // return true from the prefilter to show the row';
      $content[] = '    _.table.search(search, table, /* prefilter tr => true */ );';
      $content[] = '';
      $content[] = '    $(\'#<?= $_uidAdd ?>\').on(\'click\', function(e) {';
      $content[] = '';
      $content[] = '      _.hideContexts(e);';
      $content[] = '';
      $content[] = '      _.get.modal(_.url(\'<?= $this->route ?>/edit\'))';
      $content[] = '        .then(m => m.on(\'success\', e => refresh()));';
      $content[] = '    });';
      $content[] = '';
      $content[] = '    _.ready(() => refresh());';
      $content[] = '  })(_brayworth_);';
      $content[] = '</script>';

      file_put_contents($file, implode("\n", $content));
      echo "Created views/matrix class: $file\n";
    } else {

      echo "views/matrix class already exists: $file\n";
    }
  }

  protected static function makeCrudViewMatrixPreact(string $name, array $fields): void {

    $file = 'src/app/' . $name . '/views/matrix.php';
    if (!file_exists($file)) {

      $content = [
        '<?php',
        '  // file: ' . $file,
        '  // MIT License',
        '',
        sprintf('namespace %s;', $name),
        '',
        'use bravedave\dvc\strings; ?>',
        '',
        '<div class="row gx-2 mb-2 d-print-none">',
        '    <div class="col">',
        '        <div class="input-group">',
        '            <input type="search" accesskey="/" class="form-control" id="<?= $_search = strings::rand() ?>" autofocus>',
        '        </div>',
        '    </div>',
        '',
        '    <div class="col-auto" id="<?= $_uidAdd = strings::rand() ?>"></div>',
        '</div>',
        '',
        '<div class="table-responsive">',
        '    <table class="table table-sm" id="<?= $_table = strings::rand() ?>">',
        '        <thead class="small">',
        '            <tr>',
        '                <td class="text-center js-line-number"></td>',
      ];

      foreach ($fields as $field) {
        $content[] = sprintf('                <td>%s</td>', $field);
      }

      $content[] = '            </tr>';
      $content[] = '        </thead>';
      $content[] = '';
      $content[] = '        <tbody></tbody>';
      $content[] = '    </table>';
      $content[] = '</div>';
      $content[] = '<script type="module">';
      $content[] = '    import { h, render } from \'preact\';';
      $content[] = '    import { useState, useEffect } from \'hooks\';';
      $content[] = '    import htm from \'htm\';';
      $content[] = '';
      $content[] = '    const html = htm.bind(h);';
      $content[] = '    const _ = _brayworth_;';
      $content[] = '';
      $content[] = '    const Matrix = ({ tableId, route }) => {';
      $content[] = '        const [data, setData] = useState([]);';
      $content[] = '        const [error, setError] = useState(null);';
      $content[] = '        const [refresh, setRefresh] = useState(0); // State to trigger re-fetch';
      $content[] = '';
      $content[] = '        const fetchData = () => {';
      $content[] = '';
      $content[] = '            // console.log(\'Fetching data...\');';
      $content[] = '            _.api(_.url(route), {';
      $content[] = '                    action: \'get-matrix\'';
      $content[] = '                })';
      $content[] = '                .then(data => {';
      $content[] = '                    setData(data);';
      $content[] = '                    const el = document.getElementById(tableId);';
      $content[] = '                    if (el) el.dispatchEvent(new Event(\'update-line-numbers\')); // Trigger after data update';
      $content[] = '                })';
      $content[] = '                .catch( e => setError(e.description || e));';
      $content[] = '        };';
      $content[] = '';
      $content[] = '        const handleDelete = id => {';
      $content[] = '';
      $content[] = '            _.api(_.url(route), {';
      $content[] = '                    action: \'property-delete\',';
      $content[] = '                    id';
      $content[] = '                })';
      $content[] = '                .then(data => setData(prev => prev.filter(item => item.id !== id)))';
      $content[] = '                .catch(_.growl);';
      $content[] = '        };';
      $content[] = '';
      $content[] = '        const handleEdit = id => {';
      $content[] = '            _.get.modal(_.url(`${route}/edit/${id}`))';
      $content[] = '                .then(m => m.on(\'success\', fetchData));';
      $content[] = '        };';
      $content[] = '';
      $content[] = '        useEffect(() => fetchData(), [refresh]);';
      $content[] = '        useEffect(() => {';
      $content[] = '            const el = document.getElementById(tableId);';
      $content[] = '            if (el) el.dispatchEvent(new Event(\'update-line-numbers\'));';
      $content[] = '        }, [data]); // Runs whenever `data` changes';
      $content[] = '';
      $content[] = '        useEffect(() => {';
      $content[] = '            const el = document.getElementById(tableId);';
      $content[] = '            const handleRefresh = () => setRefresh(prev => prev + 1);';
      $content[] = '';
      $content[] = '            if (el) {';
      $content[] = '                el.addEventListener(\'refresh\', handleRefresh);';
      $content[] = '                el.addEventListener(\'update-line-numbers\', _.table._line_numbers_);';
      $content[] = '            }';
      $content[] = '';
      $content[] = '            return () => {';
      $content[] = '                if (el) {';
      $content[] = '                    el.removeEventListener(\'refresh\', handleRefresh);';
      $content[] = '                    el.removeEventListener(\'update-line-numbers\', _.table._line_numbers_);';
      $content[] = '                }';
      $content[] = '            };';
      $content[] = '        }, [tableId]);';
      $content[] = '';
      $content[] = '        if (error) return html`<div>Error: ${error}</div>`;';
      $content[] = '        if (!data.length) return html`<div>Loading...</div>`;';
      $content[] = '';
      $content[] = '        return html`';
      $content[] = '          ${data.map(dto => html`';
      $content[] = '            <tr data-id="${dto.id}" class="pointer" ';
      $content[] = '              onClick=${() => handleEdit(dto.id)} ';
      $content[] = '              onContextMenu=${e => {';
      $content[] = '                e.preventDefault();';
      $content[] = '                const _ctx = _.context(e);';
      $content[] = '                _ctx.append.a({';
      $content[] = '                  html: \'<i class="bi bi-pencil"></i>edit\',';
      $content[] = '                  click: () => handleEdit(dto.id)';
      $content[] = '                });';
      $content[] = '                _ctx.append.a({';
      $content[] = '                  html: \'<i class="bi bi-trash"></i>delete\',';
      $content[] = '                  click: () => handleDelete(dto.id)';
      $content[] = '                });';
      $content[] = '                _ctx.open(e);';
      $content[] = '              }}>';
      $content[] = '              <td class="text-center js-line-number"></td>';
      $content[] = '              <td>${dto.street}</td>';
      $content[] = '              <td>${dto.suburb}</td>';
      $content[] = '              <td>${dto.state}</td>';
      $content[] = '              <td>${dto.postcode}</td>';
      $content[] = '            </tr>`)}';
      $content[] = '        `;';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    const table = document.getElementById(\'<?= $_table ?>\');';
      $content[] = '    const search = document.getElementById(\'<?= $_search ?>\');';
      $content[] = '';
      $content[] = '    render(html`<${Matrix} tableId="<?= $_table ?>" route="<?= $this->route ?>" />`, table.querySelector(\'tbody\'));';
      $content[] = '';
      $content[] = '    const handleAdd = e => {';
      $content[] = '        _.hideContexts(e);';
      $content[] = '        _.get.modal(_.url(\'<?= $this->route ?>/edit\'))';
      $content[] = '            .then(m => m.on(\'success\', () => table.dispatchEvent(new Event(\'refresh\'))));';
      $content[] = '    };';
      $content[] = '';
      $content[] = '    render(html`<button ';
      $content[] = '        class="btn btn-outline-primary"';
      $content[] = '        onClick=${e => handleAdd(e)}>';
      $content[] = '          <i class="bi bi-plus-circle"></i> new';
      $content[] = '        </button>`, document.getElementById(\'<?= $_uidAdd ?>\'));';
      $content[] = '';
      $content[] = '    _.table.search(search, table);';
      $content[] = '</script>';

      file_put_contents($file, implode("\n", $content));
      echo "Created views/matrix class: $file\n";
    } else {

      echo "views/matrix class already exists: $file\n";
    }
  }

  public static function checkComposer(): void {
    /*
    the basic structure we require is:
    {
      "autoload": {
          "psr-4": {
              "": "src/app/"
          }
      },
      "scripts": {
          "start": [
              "Composer\\Config::disableProcessTimeout",
              "echo \"this application is available at http://localhost:8000\"",
              "php -S 0.0.0.0:8000 public/_mvp.php"
          ]
      }
    }
    */

    $changed = false;
    $composerFile = 'composer.json';
    // read in the composer.json file
    $composer = (object)[];
    if (file_exists($composerFile)) {
      $composer = json_decode(file_get_contents($composerFile));
    }

    // check there is an autoload and a autoload/psr-4 section
    if (!isset($composer->autoload)) $composer->autoload = (object)[];
    if (!isset($composer->autoload->{'psr-4'})) $composer->autoload->{'psr-4'} = (object)[];

    // check the psr-4 section has a root namespace
    $rootNamespace = isset($composer->autoload->{'psr-4'}->{''});

    if (!$rootNamespace) {

      /**
       * we would prefer to have the root namespace set in autoload-dev
       * lets roll through and if it does not exist, create it there
       */

      if (!isset($composer->{'autoload-dev'})) $composer->{'autoload-dev'} = (object)[];

      if (!isset($composer->{'autoload-dev'}->{'psr-4'})) {

        $composer->{'autoload-dev'}->{'psr-4'} = (object)[];
      }

      if (!isset($composer->{'autoload-dev'}->{'psr-4'}->{''})) {

        $composer->{'autoload-dev'}->{'psr-4'}->{''} = 'src/app/';
        $changed = true;
      }
    }


    // cool, lets check to see if we have a start script
    // check there is a scripts section
    if (!isset($composer->{'scripts'})) $composer->{'scripts'} = (object)[];

    if (!isset($composer->{'scripts'}->{'start'})) {

      $composer->{'scripts'}->{'start'} = [
        'Composer\\Config::disableProcessTimeout',
        'echo "this application is available at http://localhost:8000"',
        'php -S 127.0.0.1:8000 public/_mvp.php'
      ];
      $changed = true;
    }

    // if it was changed, write it back to the file
    if ($changed) {

      file_put_contents($composerFile, json_encode($composer, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES | JSON_UNESCAPED_UNICODE));
      echo "Updated composer.json with autoload and start script.\n";

      // they need to run composer update
      echo "Please run 'composer update' to apply the changes.\n";
    } else {

      echo "composer.json already has the required structure.\n";
    }
  }

  public static function checkDirectories($directories): void {
    foreach ($directories as $dir) {
      if (!is_dir($dir)) {
        mkdir($dir, 0777, true);
        echo "Created directory: $dir\n";
      }
    }
  }

  public static function checkFiles($files): void {

    foreach ($files as $destination => $source) {
      if (!file_exists($destination)) {

        if (file_exists($source)) {

          copy($source, $destination);
          echo "Copied $source to $destination\n";
        } else {

          echo "Source file not found: $source\n";
        }
      } else {

        echo "File already exists: $destination\n";
      }
    }
  }

  public static function checkNamespace($files, $name): void {

    foreach ($files as $destination => $source) {

      if (file_exists($destination)) {

        $content = file_get_contents($destination);
        $newContent = str_replace('namespace example;', 'namespace ' . $name . ';', $content);
        file_put_contents($destination, $newContent);
        echo "Updated namespace in: $destination\n";
      } else {

        echo "File not found: $destination\n";
      }
    }
  }

  public static function easterEgg(): void {

    $file = 'src/controller/home.php';
    if (!file_exists($file)) {

      $content = "<?php\n// file: $file\nclass home extends bravedave\dvc\hp\controller {}\n";
      file_put_contents($file, $content);
      echo "Created controller: $file\n";
    } else {

      echo "Controller already exists: $file\n";
    }

    echo "finished creating module: $file\n";
  }

  public static function help(): void {
    echo "Available commands:\n";
    echo "  serve [--port=<port>]    Start the dev server (default port: 1265)\n";
    if (!file_exists('public/_mvp.php')) {

      echo "  make::application     Create the default application\n";
    }
    echo "  make::module Name Generate a module\n";
    echo "  version              Show version\n";
    echo "\n";
    echo "  experimental !!\n";
    echo "  make::crud-module --name=<name> --fields=<field1,field2,...> --preact=(true|false)\n";
    // will probably deprecate make::container
    // echo "  make::container\n";
  }

  public static function makeApplication(): void {

    /**
     * ensure the default folder exist, and the default files exist ...
     */

    $directories = [
      'src/app',
      'src/controller',
      'public',
    ];

    $files = [
      'public/.htaccess' => 'vendor/bravedave/dvc/tests/www/.htaccess',
      'public/_mvp.php' => 'vendor/bravedave/dvc/tests/www/_mvp.php',
      'src/app/application.php' => 'vendor/bravedave/dvc/tests/app/application.php',
      'README.md' => 'vendor/bravedave/dvc/src/example/README.md',
    ];

    utility::checkDirectories($directories);  // Create directories if they don't exist
    utility::checkFiles($files);  // Copy files if they don't exist
    utility::checkComposer();  // Ensure composer.json has the correct structure
    utility::checkVSCodeSettings(); // Ensure VSCode settings.json contains required SQLTools config
    utility::checkVSCodeTasks(); // Ensure VSCode tasks.json contains dev server launch task

    echo "Default application setup complete.\n";
    printf("to run the application type php %s server\n", __FILE__);
  }

  public static function makeContainer(): void {

    /**
     * __FILE__ = /home/davbr/github/tutor/vendor/bravedave/dvc/src/bin/dvc
     * __DIR__  = /home/davbr/github/tutor/vendor/bravedave/dvc/src/bin
     * the docker files will be in ../docker
     */

    $currentDir = getcwd();

    $docker = __DIR__ . '/../docker';
    $dockerDir = realpath($docker);
    if (!$dockerDir) {
      echo "docker directory not found: $docker\n";
      return;
    }

    echo "currentDir = $currentDir\n";
    echo "docker = $docker\n";
    echo "dockerDir = $dockerDir\n";

    /**
     * todo
     * - make a local docker directory if it does not exist
     * - copy the files from $dockerDir to ./docker
     */
    // if (!is_dir('docker')) {

    //   if (!mkdir('docker', 0777, true)) {

    //     echo "failed to create docker directory in current directory\n";
    //     return;
    //   }
    // }
    $dirs = [
      'docker',
      'docker/Caddyfile.d',
    ];
    utility::checkDirectories($dirs);

    $dockerfiles = [
      'docker/fpm.Dockerfile' => $dockerDir . '/fpm85.Dockerfile',
      'docker/docker-compose.yaml' => $dockerDir . '/docker-compose.yaml',
      'docker/my.server.cnf' => $dockerDir . '/my.server.cnf',
      'docker/php.ini' => $dockerDir . '/php.ini',
      'docker/Caddyfile' => $dockerDir . '/Caddyfile'
    ];
    $frank = [
      'docker/Dockerfile' => $dockerDir . '/frank/Dockerfile',
      'docker/docker-compose.yaml' => $dockerDir . '/frank/docker-compose.yaml',
      'docker/Caddyfile.d/app.caddyfile' => $dockerDir . '/frank/Caddyfile.d/app.caddyfile',
      'docker/my.server.cnf' => $dockerDir . '/my.server.cnf',
      'docker/php.ini' => $dockerDir . '/php.ini',
      'docker/Caddyfile' => $dockerDir . '/Caddyfile'
    ];
    $dockerfiles = $frank;
    utility::checkFiles($dockerfiles);

    /**
     * the working directories need to be established
     * and their ownership needs to be set to the devuser (1000:1000)
     * mariadb will create its own data directory
     */
    $dirs = [
      "./workspace/mariadb",
      "./workspace/home/devuser/bin"
    ];

    utility::checkDirectories($dirs);
    foreach ($dirs as $dir) {
      chown($dir, 1000);
      chgrp($dir, 1000);
    }

    /**
     * Create a .env file in the docker directory if it does not exist
     * HOST_UID=1000
     * HOST_GID=1000
     *
     * MYSQL_ROOT_PASSWORD=[generate a random password here]
     * MYSQL_DATABASE=dvc
     * MYSQL_USER=developers
     * MYSQL_PASSWORD=[generate a random password here]
     */

    $envFile = 'docker/.env';
    if (!file_exists($envFile)) {
      $password = substr(str_shuffle('abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'), 0, 12);
      $content = [
        'HOST_UID=1000',
        'HOST_GID=1000',
        '',
        "MYSQL_ROOT_PASSWORD=$password",
        'MYSQL_DATABASE=dvc',
        'MYSQL_USER=developers',
        "MYSQL_PASSWORD=$password",
      ];
      file_put_contents($envFile, implode("\n", $content));
      echo "Created docker/.env file\n";
    } else {

      echo "docker/.env file already exists\n";
    }

    // place a gitignore file in the docker directory if it does not exist and ensure the .env file is ignored
    $gitignoreFile = 'docker/.gitignore';
    if (!file_exists($gitignoreFile)) {
      $content = [
        '.env'
      ];
      file_put_contents($gitignoreFile, implode("\n", $content));
      echo "Created docker/.gitignore file\n";
    } else {

      echo "docker/.gitignore file already exists\n";
    }

    $env = (object)[];
    $lines = file('docker/.env', FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    foreach ($lines as $line) {
      if (str_contains($line, '=')) {
        [$key, $value] = explode('=', $line, 2);
        $env->{$key} = $value;
      }
    }

    /**
     * relative to this folder, ../src/data make it may not exist
     * if it does not exist, create it
     * create db.json in that folder
     * with the following content
     * {
     *  "db_type": "mysql",
     *  "db_host": "mariadb",
     *  "db_name": read from docker/.env MYSQL_DATABASE,
     *  "db_user": "developers",
     *  "db_pass": read from docker/.env MYSQL_PASSWORD
     * }
     * and set its ownership to 1000:1000
     *
     */

    if (!is_dir('src/data')) {

      if (!mkdir('src/data', 0777, true)) {

        echo "failed to create src/data directory in current directory\n";
        return;
      }
    }

    $dbFile = 'src/data/db.json';
    if (!file_exists($dbFile)) {

      $content = [
        '{',
        '  "db_type": "mysql",',
        '  "db_host": "mariadb",',
        sprintf('  "db_name": "%s",', $env->MYSQL_DATABASE ?? 'dvc'),
        '  "db_user": "developers",',
        sprintf('  "db_pass": "%s"', $env->MYSQL_PASSWORD ?? 'password'),
        '}',
      ];
      file_put_contents($dbFile, implode("\n", $content));
      chown($dbFile, 1000);
      chgrp($dbFile, 1000);
      echo "Created src/data/db.json file\n";
    } else {

      echo "src/data/db.json file already exists\n";
    }

    /**
     * and in the same folder create a defaults.json file
     * {
     *   "db_type": "mysql",
     *   "db_cache": "APC",
     *   "date_format": "d/m/Y",
     *   "datetime_format": "d/m/Y g:ia",
     *   "email_errors_to_support": false,
     *   "emaildomain": "example.tld",
     *   "imap_auth_server": "",
     *   "maildsn": "smtp://mail:25?verify_peer=0",
     *   "timezone": "Australia/Queensland",
     * }
     */
    $defaultsFile = 'src/data/defaults.json';
    if (!file_exists($defaultsFile)) {

      $content = [
        '{',
        '  "db_type": "mysql",',
        '  "db_cache": "APC",',
        '  "date_format": "d/m/Y",',
        '  "datetime_format": "d/m/Y g:ia",',
        '  "email_errors_to_support": false,',
        '  "emaildomain": "example.tld",',
        '  "imap_auth_server": "",',
        '  "maildsn": "smtp://mail:25?verify_peer=0",',
        '  "timezone": "Australia/Queensland"',
        '}',
      ];
      file_put_contents($defaultsFile, implode("\n", $content));
      chown($defaultsFile, 1000);
      chgrp($defaultsFile, 1000);
      echo "Created src/data/defaults.json file\n";
    } else {

      echo "src/data/defaults.json file already exists\n";
    }

    /**
     * in the folder workspace/home/devuser
     * create a .profile file if it does not exist
     * add the folder ~/bin to the PATH if it is not already there
     */
    $profileFile = 'workspace/home/devuser/.profile';
    if (!file_exists($profileFile)) {

      $content = [
        '# ~/.profile: executed by Bourne-compatible login shells.',
        '',
        '# set PATH so it includes user\'s private bin if it exists',
        'if [ -d "$HOME/bin" ] ; then',
        '    PATH="$HOME/bin:$PATH"',
        'fi',
        '',
        'export PATH',
      ];
      file_put_contents($profileFile, implode("\n", $content));
      chown($profileFile, 1000);
      chgrp($profileFile, 1000);
      echo "Created workspace/home/devuser/.profile file\n";
    } else {

      echo "workspace/home/devuser/.profile file already exists\n";
    }

    // and create a my.cnf file in workspace/home/devuser to conect to mariadb
    $myCnfFile = 'workspace/home/devuser/.my.cnf';
    if (!file_exists($myCnfFile)) {

      $content = [
        '[client]',
        'host = mariadb',
        sprintf('user = %s', $env->MYSQL_USER ?? 'developers'),
        sprintf('password = %s', $env->MYSQL_PASSWORD ?? 'password'),
        sprintf('database = %s', $env->MYSQL_DATABASE ?? 'dvc'),
        ''
      ];
      file_put_contents($myCnfFile, implode("\n", $content));
      chown($myCnfFile, 1000);
      chgrp($myCnfFile, 1000);
      echo "Created workspace/home/devuser/.my.cnf file\n";
    } else {

      echo "workspace/home/devuser/.my.cnf file already exists\n";
    }

    /**
     * Into the home folder create a vscode workspace file - app-dvc.code-workspace
     * with the following content
     * {
     *	"folders": [
     *		{
     *			"path": "/var/www/app"
     *		}
     *	],
     *	"settings": {
     *		"files.autoSave": "afterDelay",
     *		"sqltools.useNodeRuntime": false,
     *		"sqltools.connections": [
     * 			{
     * 				"mysqlOptions": {
     * 					"authProtocol": "default",
     * 					"enableSsl": "Disabled"
     * 				},
     * 				"ssh": "Disabled",
     * 				"previewLimit": 50,
     * 				"server": "mysql.internal",
     * 				"port": 3306,
     * 				"driver": "MariaDB",
     * 				"name": "MariaDB",
     * 				"database": read from docker/.env MYSQL_DATABASE,
     * 				"username": read from docker/.env MYSQL_USER,
     * 				"password": read from docker/.env MYSQL_PASSWORD
     * 			}
     * 		]
     * 	}
     * }
     */
    $workspaceFile = 'workspace/home/devuser/app-dvc.code-workspace';
    if (!file_exists($workspaceFile)) {

      $content = [
        '{',
        '  "folders": [',
        '    {',
        '      "path": "/var/www/app"',
        '    }',
        '  ],',
        '  "settings": {',
        '    "files.autoSave": "afterDelay",',
        '    "sqltools.useNodeRuntime": false,',
        '    "sqltools.connections": [',
        '      {',
        '        "mysqlOptions": {',
        '          "authProtocol": "default",',
        '          "enableSsl": "Disabled"',
        '        },',
        '        "ssh": "Disabled",',
        '        "previewLimit": 50,',
        '        "server": "mariadb",',
        '        "port": 3306,',
        '        "driver": "MariaDB",',
        '        "name": "MariaDB",',
        sprintf('        "database": "%s",', $env->MYSQL_DATABASE ?? 'dvc'),
        sprintf('        "username": "%s",', $env->MYSQL_USER ?? 'developers'),
        sprintf('        "password": "%s"', $env->MYSQL_PASSWORD ?? 'password'),
        '      }',
        '    ]',
        '  }',
        '}'
      ];
      file_put_contents($workspaceFile, implode("\n", $content));
      chown($workspaceFile, 1000);
      chgrp($workspaceFile, 1000);
      echo "Created workspace/home/devuser/app-dvc.code-workspace file\n";
    } else {

      echo "workspace/home/devuser/app-dvc.code-workspace file already exists\n";
    }

    echo "docker container setup complete\n";
    printf("to start the containers type 'docker compose -f docker/docker-compose.yaml up -d'\n");
  }

  public static function makeCrudModule(string $name, string $fields, bool $preact): void {

    // Process fields
    $fieldArray = $fields ? explode(',', $fields) : [];

    static::makeModule($name, $createFiles = false);
    static::makeCrudDBInfo($name, $fieldArray);
    static::makeCrudDBMaintence($name, $fieldArray);
    static::makeCrudDTO($name, $fieldArray);
    static::makeCrudDAO($name, $fieldArray);
    static::makeCrudController($name, $fieldArray);
    static::makeCrudConfig($name, $fieldArray);
    static::makeCrudHandler($name, $fieldArray);
    static::makeCrudViewEdit($name, $fieldArray);
    static::makeCrudViewIndex($name, $fieldArray);

    if ($preact) {

      static::makeCrudViewMatrixPreact($name, $fieldArray);
    } else {

      static::makeCrudViewMatrix($name, $fieldArray);
    }
  }

  public static function makeModule(string $name, bool $createFiles = true): void {
    // ensure name is valid
    if (!preg_match('/^[a-zA-Z0-9_]+$/', $name)) {
      printf("Invalid module name: %s\n", $name);
      exit(1);
    }

    $directories = [
      'src/app/' . $name,
      'src/app/' . $name . '/views',
      'src/app/' . $name . '/dao',
      'src/app/' . $name . '/dao/db',
      'src/app/' . $name . '/dao/dto',
      'src/controller'
    ];

    $files = [
      'src/app/' . $name . '/config.php' => 'vendor/bravedave/dvc/src/example/config.php',
      'src/app/' . $name . '/controller.php' => 'vendor/bravedave/dvc/src/example/controller.php',
      'src/app/' . $name . '/views/index.php' => 'vendor/bravedave/dvc/src/example/views/index.php'
    ];

    utility::checkDirectories($directories);  // Create directories if they don't exist

    if ($createFiles) {

      utility::checkFiles($files);  // Copy files if they don't exist
      utility::checkNamespace($files, $name);  // Copy files if they don't exist
    }

    $file = 'src/controller/' . $name . '.php';
    if (!file_exists($file)) {

      $content = "<?php\n// file: $file\nclass $name extends $name\controller {}\n";
      file_put_contents($file, $content);
      echo "Created controller: $file\n";
    } else {

      echo "Controller already exists: $file\n";
    }

    echo "finished creating module: $file\n";
  }

  public static function serve($port = null): void {

    $actualPort = $port ?? static::$port;

    if (is_dir('public')) {

      printf("Starting local dev server at http://localhost:%s...\n", $actualPort);
      chdir('public');
      passthru(sprintf('DEVELOPER=1 php -S 0.0.0.0:%s _mvp.php', $actualPort));
    } elseif (file_exists('tests/www/_mvp.php')) {

      printf("Starting local dev server at http://localhost:%s...\n", $actualPort);
      chdir('tests/www');
      passthru(sprintf('DEVELOPER=1 php -S 0.0.0.0:%s _mvp.php', $actualPort));
    } elseif (file_exists('vendor/bravedave/dvc/tests/www/_mvp.php')) {

      echo "\n\napplication not found \n";
      printf("to setup the default application type php %s make:application\n", __FILE__);
    }
  }
}

switch ($command) {
  case 'easter-egg':

    utility::easterEgg();
    break;

  case 'serve':
    utility::serve($port);
    break;

  case 'make::application':
    utility::makeApplication();
    break;

  case 'make::container':
    utility::makeContainer();
    break;

  case 'make::module':

    $name = $args[1] ?? null;
    if (!$name) {
      printf("\n\nUsage: php %s make:module <Name>\n\n\n", __FILE__);
      exit(1);
    }

    utility::makeModule($name);
    break;
  case 'make::crud-module':

    $name = '';
    $fields = '';
    $preact = '';
    foreach ($args as $arg) {
      if (preg_match('/-name=(.*)/', $arg, $matches)) {
        $name = $matches[1];
      } elseif (preg_match('/-fields=(.*)/', $arg, $matches)) {
        $fields = $matches[1];
      } elseif (preg_match('/-preact=(.*)/', $arg, $matches)) {
        $preact = $matches[1];
      }
    }

    if (!$name || !$fields) {

      printf("\n\nUsage: php %s make:crud-module -name=<Name> -fields=<field1,field2...> --preact=(true|false)\n\n\n", __FILE__);
      exit(1);
    }

    utility::makeCrudModule($name, $fields, $preact == 'true');
    break;

  default:
    utility::help();
    break;
}
